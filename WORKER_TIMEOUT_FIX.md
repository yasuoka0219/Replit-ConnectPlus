# ワーカータイムアウトエラーの修正

## 🔴 発生していたエラー

デプロイログで以下のエラーが確認されました：

1. **WORKER TIMEOUT**: `[CRITICAL] WORKER TIMEOUT (pid:4)`
2. **SMTP接続エラー**: SendGridのSMTPサーバーへの接続がタイムアウト
3. **エラー発生箇所**: `/app/utils/email_2fa.py`, line 150 の `smtplib.SMTP` 接続

## 🔍 原因

SMTP接続のタイムアウトが60秒に設定されていたため、Railwayのワーカータイムアウト（通常30秒）を超えてしまい、ワーカーがタイムアウトしていました。

## ✅ 修正内容

### 1. タイムアウトを短縮

- **変更前**: 60秒
- **変更後**: 10秒
- **理由**: Railwayのワーカータイムアウトを考慮し、より短いタイムアウトに設定

### 2. リトライ回数を減らす

- **変更前**: 3回
- **変更後**: 2回
- **理由**: タイムアウトを避けるため、リトライ回数を減らす

### 3. 修正したファイル

- `utils/email_2fa.py`
- `utils/email_sender.py`
- `utils/password_reset.py`

---

## 🚀 次のステップ

### ステップ1: GitHubにプッシュ

```bash
cd /Users/okazakikatsuhiro/Downloads/Replit-ConnectPlus-main
git push origin main
```

### ステップ2: Railwayで自動デプロイを待つ

Railwayが自動的にGitHubから最新のコードを取得してデプロイします。
通常、数分かかります。

### ステップ3: 動作確認

1. アプリケーションにアクセス
2. 「設定」→「2段階認証設定」
3. 「2段階認証を設定する（メール認証）」をクリック
4. エラーが発生しないことを確認
5. メールが届くことを確認

---

## 🔍 トラブルシューティング

### まだタイムアウトが発生する場合

1. **ポートを変更してみる**
   - Railwayダッシュボード → 「Variables」
   - `SMTP_PORT` を `587` から `465` に変更
   - 保存して再デプロイ

2. **ログを確認**
   - Railwayダッシュボード → 「HTTP Logs」
   - `[2FA Email]` で始まるログを確認
   - エラーメッセージの詳細を確認

3. **SendGridのAPIキーを確認**
   - SendGridダッシュボード → 「Settings」→「API Keys」
   - APIキーが有効か確認
   - Railwayで `SMTP_PASSWORD` を再確認

---

## 📋 チェックリスト

- [ ] GitHubにプッシュ
- [ ] Railwayで自動デプロイを待つ
- [ ] デプロイログでエラーが発生していないことを確認
- [ ] 2段階認証設定を試す
- [ ] メールが届くことを確認

---

**これで、ワーカータイムアウトエラーが解消されるはずです！**
