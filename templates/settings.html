{% extends "base.html" %}

{% block title %}設定 - CONNECT+{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">設定</h1>
    <p class="text-gray-600 dark:text-gray-400">アカウント設定とシステム情報</p>
</div>

<div class="max-w-3xl">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-200 dark:border-gray-700 mb-6">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-white">組織情報</h2>
            <button onclick="toggleOrgEdit()" id="orgEditBtn" class="px-4 py-2 bg-primary hover:bg-indigo-700 text-white rounded-lg">編集</button>
        </div>
        
        <div id="orgView" {% if not org_profile %}style="display: none;"{% endif %}>
            <div class="space-y-4">
                <div class="py-3 border-b border-gray-200 dark:border-gray-700">
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">組織名</p>
                    <p class="text-gray-900 dark:text-white mt-1" id="viewOrgName">{{ org_profile.org_name if org_profile else '-' }}</p>
                </div>
                <div class="py-3 border-b border-gray-200 dark:border-gray-700">
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">住所</p>
                    <p class="text-gray-900 dark:text-white mt-1" id="viewAddress">{{ org_profile.address if org_profile else '-' }}</p>
                </div>
                <div class="py-3 border-b border-gray-200 dark:border-gray-700">
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">電話番号</p>
                    <p class="text-gray-900 dark:text-white mt-1" id="viewPhone">{{ org_profile.phone if org_profile else '-' }}</p>
                </div>
                <div class="py-3">
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">メールアドレス</p>
                    <p class="text-gray-900 dark:text-white mt-1" id="viewEmail">{{ org_profile.email if org_profile else '-' }}</p>
                </div>
            </div>
        </div>

        <form id="orgForm" style="display: none;">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">組織名</label>
                    <input type="text" id="org_name" value="{% if org_profile %}{{ org_profile.org_name }}{% endif %}" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">組織名（カナ）</label>
                    <input type="text" id="org_name_kana" value="{% if org_profile %}{{ org_profile.org_name_kana }}{% endif %}" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">郵便番号</label>
                    <input type="text" id="postal_code" value="{% if org_profile %}{{ org_profile.postal_code }}{% endif %}" placeholder="123-4567" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">住所</label>
                    <input type="text" id="address" value="{% if org_profile %}{{ org_profile.address }}{% endif %}" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">電話番号</label>
                    <input type="text" id="phone" value="{% if org_profile %}{{ org_profile.phone }}{% endif %}" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">メールアドレス</label>
                    <input type="email" id="email" value="{% if org_profile %}{{ org_profile.email }}{% endif %}" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">代表者名</label>
                    <input type="text" id="representative" value="{% if org_profile %}{{ org_profile.representative }}{% endif %}" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">登録番号（インボイス）</label>
                    <input type="text" id="registration_number" value="{% if org_profile %}{{ org_profile.registration_number }}{% endif %}" placeholder="T1234567890123" class="w-full px-4 py-3 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit" class="px-6 py-2 bg-primary hover:bg-indigo-700 text-white rounded-lg">保存</button>
                    <button type="button" onclick="cancelOrgEdit()" class="px-6 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg">キャンセル</button>
                </div>
            </div>
        </form>
    </div>

    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-200 dark:border-gray-700 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">アカウント情報</h2>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">名前</p>
                    <p class="text-gray-900 dark:text-white mt-1">{{ current_user.name }}</p>
                </div>
            </div>
            
            <div class="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">メールアドレス</p>
                    <p class="text-gray-900 dark:text-white mt-1">{{ current_user.email }}</p>
                </div>
            </div>
            
            <div class="flex items-center justify-between py-3">
                <div>
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">登録日</p>
                    <p class="text-gray-900 dark:text-white mt-1">{{ current_user.created_at.strftime('%Y年%m月%d日') }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-200 dark:border-gray-700 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">セキュリティ設定</h2>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between py-3 border-b border-gray-200 dark:border-gray-700">
                <div>
                    <p class="font-medium text-gray-900 dark:text-white">2段階認証</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">アカウントのセキュリティを強化します</p>
                </div>
                <a href="{{ url_for('settings_2fa') }}" class="px-4 py-2 bg-primary hover:bg-indigo-700 text-white font-medium rounded-lg transition duration-200">
                    設定
                </a>
            </div>
            
            {% if has_role(current_user, 'admin') %}
            <div class="flex items-center justify-between py-3">
                <div>
                    <p class="font-medium text-gray-900 dark:text-white">セキュリティログ</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">認証イベントと重要な操作の記録を確認</p>
                </div>
                <a href="{{ url_for('security_logs') }}" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white font-medium rounded-lg transition duration-200">
                    表示
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-200 dark:border-gray-700 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">連携設定</h2>
        
        <div class="space-y-4">
            <div class="flex items-center justify-between py-3">
                <div>
                    <p class="font-medium text-gray-900 dark:text-white">Googleカレンダー連携</p>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">タスクやアポイントメントを自動的に同期します</p>
                </div>
                <a href="{{ url_for('settings_calendar') }}" class="px-4 py-2 bg-primary hover:bg-indigo-700 text-white font-medium rounded-lg transition duration-200">
                    設定
                </a>
            </div>
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-200 dark:border-gray-700 mb-6">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">表示設定</h2>
        
        <div class="flex items-center justify-between">
            <div>
                <p class="font-medium text-gray-900 dark:text-white">テーマ</p>
                <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">ライトモード / ダークモード</p>
            </div>
            <button onclick="toggleTheme()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition duration-200">
                テーマ切替
            </button>
        </div>
    </div>
    
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-8 border border-gray-200 dark:border-gray-700">
        <h2 class="text-xl font-semibold text-gray-900 dark:text-white mb-6">システム情報</h2>
        
        <div class="space-y-4">
            <div class="py-3 border-b border-gray-200 dark:border-gray-700">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300">アプリケーション名</p>
                <p class="text-gray-900 dark:text-white mt-1">CONNECT+</p>
            </div>
            
            <div class="py-3 border-b border-gray-200 dark:border-gray-700">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300">バージョン</p>
                <p class="text-gray-900 dark:text-white mt-1">1.0.0</p>
            </div>
            
            <div class="py-3">
                <p class="text-sm font-medium text-gray-700 dark:text-gray-300">説明</p>
                <p class="text-gray-900 dark:text-white mt-1">フルスタックCRMシステム - 顧客・案件・タスクを一元管理</p>
            </div>
        </div>
    </div>
</div>

<script>
let isEditing = false;

function toggleOrgEdit() {
    const orgView = document.getElementById('orgView');
    const orgForm = document.getElementById('orgForm');
    const editBtn = document.getElementById('orgEditBtn');
    
    if (isEditing) {
        orgView.style.display = 'block';
        orgForm.style.display = 'none';
        editBtn.textContent = '編集';
    } else {
        orgView.style.display = 'none';
        orgForm.style.display = 'block';
        editBtn.textContent = 'キャンセル';
    }
    isEditing = !isEditing;
}

function cancelOrgEdit() {
    toggleOrgEdit();
}

document.getElementById('orgForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        org_name: document.getElementById('org_name').value,
        org_name_kana: document.getElementById('org_name_kana').value,
        postal_code: document.getElementById('postal_code').value,
        address: document.getElementById('address').value,
        phone: document.getElementById('phone').value,
        email: document.getElementById('email').value,
        representative: document.getElementById('representative').value,
        registration_number: document.getElementById('registration_number').value
    };
    
    try {
        const response = await fetch('/api/org-profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            document.getElementById('viewOrgName').textContent = data.org_name || '-';
            document.getElementById('viewAddress').textContent = data.address || '-';
            document.getElementById('viewPhone').textContent = data.phone || '-';
            document.getElementById('viewEmail').textContent = data.email || '-';
            
            alert('組織情報を保存しました');
            toggleOrgEdit();
        } else {
            alert('エラー: ' + result.error);
        }
    } catch (error) {
        alert('保存に失敗しました: ' + error.message);
    }
});

{% if not org_profile %}
document.getElementById('orgForm').style.display = 'block';
document.getElementById('orgEditBtn').textContent = 'キャンセル';
isEditing = true;
{% endif %}
</script>
{% endblock %}
