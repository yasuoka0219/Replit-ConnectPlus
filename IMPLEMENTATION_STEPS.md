# メール送信機能実装手順（完了版）

## ✅ 実装完了内容

以下の機能を実装しました：

1. ✅ **汎用的なメール送信機能** (`utils/email_sender.py`)
2. ✅ **連絡先へのメール送信API** (`/api/contacts/<id>/send-email`)
3. ✅ **連絡先詳細画面にメール送信ボタン** (`templates/company_detail.html`)
4. ✅ **メール送信モーダル** (UI)

---

## 🚀 次のステップ：SMTP設定の確認

### ステップ1: SMTP設定のテスト

まず、SMTP設定が正しく動作するか確認します：

```bash
python test_smtp.py
```

このスクリプトは：
- SMTP設定を確認
- テストメールを送信
- エラーがあれば詳細を表示

### ステップ2: 環境変数の設定

本番環境で以下の環境変数を設定してください：

```bash
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-16-digit-app-password
SMTP_FROM_EMAIL=your-email@gmail.com
SMTP_FROM_NAME=CONNECT+ CRM
```

**Gmailアプリパスワードの取得方法：**
1. Googleアカウント設定 → セキュリティ
2. 2段階認証を有効化
3. アプリパスワードを生成
4. 16文字のパスワードをコピー

詳細は [Gmail SMTP設定ガイド](./GMAIL_SMTP_SETUP.md) を参照してください。

### ステップ3: アプリケーションの再起動

環境変数を設定した後、アプリケーションを再起動してください。

### ステップ4: 2段階認証メールの確認

1. アプリケーションにログイン
2. 「設定」→「2段階認証設定」を開く
3. 「2段階認証を設定する（メール認証）」をクリック
4. メールで認証コードを受信
5. コードを入力して有効化

**✅ メールが届けば、SMTP設定は正常です！**

---

## 📧 連絡先へのメール送信機能の使い方

### 使い方

1. **企業詳細画面にアクセス**
   - 企業一覧から企業を選択
   - 「連絡先」タブを開く

2. **メール送信ボタンをクリック**
   - 連絡先のメールアドレスの横にある「メール送信」ボタンをクリック
   - または、連絡先カードの「メール送信」ボタンをクリック

3. **メール送信フォームに入力**
   - 送信先：自動入力（変更不可）
   - 件名：メールの件名を入力
   - 本文：メールの本文を入力

4. **送信**
   - 「送信」ボタンをクリック
   - メールが送信されます
   - 活動履歴に自動記録されます

---

## 🔍 動作確認

### 確認項目

1. **2段階認証メールが届く**
   - ✅ ログイン時にメールで認証コードを受信
   - ✅ 2段階認証設定時にメールで認証コードを受信

2. **連絡先へのメール送信ができる**
   - ✅ 連絡先詳細画面で「メール送信」ボタンが表示される
   - ✅ メール送信フォームが表示される
   - ✅ メールが送信される
   - ✅ 活動履歴に記録される

3. **エラーハンドリング**
   - ✅ SMTP設定がない場合、適切なエラーメッセージが表示される
   - ✅ メール送信失敗時、エラーメッセージが表示される

---

## 🆘 トラブルシューティング

### 2段階認証メールが届かない

1. **SMTP設定を確認**
   ```bash
   python test_smtp.py
   ```

2. **ログを確認**
   - 本番環境のログでエラーメッセージを確認
   - `[2FA Email] ❌`で始まるエラーメッセージがないか確認

3. **環境変数を再確認**
   - 本番環境で環境変数が正しく設定されているか
   - アプリケーションを再起動

4. **ログから認証コードを確認**
   - メールが届かなくても、ログに認証コードが表示されます
   - ログから認証コードを確認して一時的に使用

### 連絡先へのメール送信が失敗する

1. **SMTP設定を確認**
   - 2段階認証メールが届くか確認
   - 同じSMTP設定を使用

2. **連絡先のメールアドレスを確認**
   - メールアドレスが正しく登録されているか
   - メールアドレスの形式が正しいか

3. **ログを確認**
   - エラーメッセージを確認
   - `[Email] ❌`で始まるエラーメッセージがないか確認

---

## 📚 参考資料

- [Gmail SMTP設定ガイド](./GMAIL_SMTP_SETUP.md)
- [メール送信機能実装ガイド](./EMAIL_IMPLEMENTATION_GUIDE.md)
- [本番環境メール機能実装手順](./PRODUCTION_EMAIL_SETUP.md)

---

## 🎉 実装完了！

これで、以下の機能が利用可能になりました：

- ✅ 2段階認証メール送信
- ✅ パスワードリセットメール送信
- ✅ 連絡先へのメール送信
- ✅ 活動履歴への自動記録

**次のステップ**: `python test_smtp.py` を実行してSMTP設定を確認してください！
